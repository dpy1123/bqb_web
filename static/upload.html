<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
    <title>Document</title>
</head>
<body>
    <div id='uploader'>
        <input type="file" multiple="multiple" name="file[]" accept="image/png,image/gif" >
        <button>upload!</button>
        progress: <span id='progress'>0</span>%

        <script>
            var results = []
            var url = 'http://127.0.0.1:8009/uploads'       
            var batch_size = 2
            
            document.querySelector('#uploader button').addEventListener('click', function(event) {
                let files = document.querySelector('input').files  
                var batch_number = Math.floor(files.length / batch_size)
                var reast = files.length % batch_size
                if(batch_number > 0) {
                    for (var i = 0; i < batch_number; i++) {
                        var form_data = new FormData()
                        for (var j = 0; j < batch_size; j++) {
                            var file = files[i*batch_number+j]
                            form_data.append(file.name, file)
                        }
                        post_data(url, form_data, function(result){
                            results.push(result)
                            update_progress(results.length, batch_number)
                        })                
                    }
                }
                if(reast > 0) {
                    var form_data = new FormData()
                    for (var j = 0; j < reast; j++) {
                        var file = files[batch_size*batch_number+j]
                        form_data.append(file.name, file)
                    }
                    post_data(url, form_data, function(result){
                        results.push(result)
                        update_progress(results.length, batch_number+1)
                    })
                }
            }, false)

            function update_progress(current, total) {
                document.querySelector('#progress').innerText = current/total * 100
            }

            function post_data(url, data, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('post', url);
                xhr.onreadystatechange = function () {
                    if ( xhr.readyState === xhr.DONE ) {
                        if ( xhr.status === 200 || xhr.status === 0 ) {
                            if ( xhr.responseText ) {
                                var json = JSON.parse(xhr.responseText)
                                callback( json )
                            }
                        }
                    }
                }
                xhr.send(data);
            }

            document.querySelector('#uploader input').addEventListener('change', function(event_obj) {
                let files = document.querySelector('#uploader input').files
                if (files < 1) return  
                old_ul = document.querySelector('ul')
                new_ul = build_list(files)
                if(old_ul)
                    document.querySelector('#uploader').replaceChild(new_ul, old_ul)
                else
                    document.querySelector('#uploader').appendChild(new_ul)

            }, false)

            function build_list(file_list) {
                let ul = document.createElement('ul')
                for (var i = 0; i < file_list.length; i++) {
                    var file = file_list[i];
                    let li = document.createElement('li')
                    li.innerText = file.name+' ['+Math.round(file.size/1024)+'k] '
                    if(file.size <= 1024 * 1024) {       
                        var reader = new FileReader();  
                        reader.readAsDataURL(file);  
                        reader.onload = function(event){  
                            //console.log(event)
                            var img = document.createElement('img')
                            img.style['width'] = '100px'
                            img.src = event.target.result   
                            li.appendChild(img)
                        }  
                    }
                    ul.appendChild(li)
                }
                return ul
            }
        </script>
    </div>
</body>
</html>
